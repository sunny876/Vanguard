"use strict";var U=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var J=(e,t)=>{for(var s in t)U(e,s,{get:t[s],enumerable:!0})},j=(e,t,s,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of $(t))!V.call(e,n)&&n!==s&&U(e,n,{get:()=>t[n],enumerable:!(r=K(t,n))||r.enumerable});return e};var W=e=>j(U({},"__esModule",{value:!0}),e);var ie={};J(ie,{ApiV1:()=>O,ApiV2:()=>F,streamQueryV1:()=>M,streamQueryV2:()=>z});module.exports=W(ie);var O={};var F={};var A="%START_SNIPPET%",w="%END_SNIPPET%";var H=e=>{if(!e)return;let t=[],{response:s,document:r}=e;return s.forEach(n=>{let{documentIndex:u,text:m}=n,{pre:f,post:y,text:l}=Y(m),h=r[Number(u)],{id:v,metadata:x}=h,{source:E,url:b,title:a,metadata:I}=X(x);t.push({id:v,snippet:{pre:f,text:l,post:y},source:E,url:b,title:a,metadata:I})}),t},X=e=>{let t=Z(e);return{source:t.source,url:t.url,title:t.title||"Untitled",metadata:t}},Y=e=>{let[t,s]=e.indexOf(A)!==-1?e.split(A):["",e],[r,n]=s.indexOf(w)!==-1?s.split(w):[s,""];return{pre:t,post:n,text:r}},Z=e=>{let t={};return e.forEach(s=>{t[s.name]=s.value}),t};var L=(e,t)=>{e.split(`
`).filter(r=>r!=="").forEach(t)};var D="https://api.vectara.io";var N=async(e,t,s)=>{let r=new AbortController,n=await fetch(s,{method:"POST",headers:e,body:t,signal:r.signal});if(!n.ok)throw new Error(`Request failed (${n.statusText})`,{cause:n.status});if(!n.body)throw new Error("Response body does not exist");return{stream:ee(n.body),cancelStream:()=>r.abort(),status:n.status,responseHeaders:n.headers}};async function*ee(e){let t=e.getReader(),s=new TextDecoder;for(;;){let{value:r,done:n}=await t.read();if(n)break;yield s.decode(r,{stream:!0})}}var M=async(e,t)=>{var h,v,x,E,b,a,I,C;let s={"x-api-key":e.apiKey,"customer-id":e.customerId,"Content-Type":"application/json"},r=(h=e.lambda)!=null?h:.025;r>1?r=1:r<0&&(r=0);let n=e.corpusIds.map(p=>({customerId:e.customerId,corpusId:p,lexicalInterpolationConfig:{lambda:r},metadataFilter:e.filter?`doc.source = '${e.filter}'`:void 0})),u=e.rerank?{rerankingConfig:{rerankerId:e.rerankerId,...e.rerankerId===272725718?{mmrConfig:{diversityBias:e.rerankDiversityBias}}:{}}}:{},m=JSON.stringify({query:[{query:e.queryValue,start:0,numResults:e.rerank?e.rerankNumResults:10,corpusKey:n,contextConfig:{sentencesBefore:(v=e.summaryNumSentences)!=null?v:2,sentencesAfter:(x=e.summaryNumSentences)!=null?x:2,startTag:A,endTag:w},summary:[{responseLang:e.language,debug:e.debug,maxSummarizedResults:e.summaryNumResults,summarizerPromptName:e.summaryPromptName,factualConsistencyScore:(E=e.enableFactualConsistencyScore)!=null?E:!1,chat:{store:(a=(b=e.chat)==null?void 0:b.store)!=null?a:!1,conversationId:(I=e.chat)==null?void 0:I.conversationId}}],...u}]}),f=(C=e.endpoint)!=null?C:`${D}/v1/stream-query`,{stream:y}=await N(s,m,f),l="";for await(let p of y)try{L(p,g=>{var S,R,P;let o=JSON.parse(g);if(!o.result)return;let d={},T=te(e,o.result);T&&(d.summary=T);let k=re(e,o.result);k&&(d.chat=k);let c=se(o.result);c&&(d.factualConsistency=c);let _={references:H(o.result.responseSet),details:d,updatedText:ne(o.result,l),isDone:(R=(S=o.result.summary)==null?void 0:S.done)!=null?R:!1};l=(P=_.updatedText)!=null?P:"",t(_)})}catch(g){console.log(g)}},te=(e,t)=>{if(t.summary&&e.debug&&t.summary.prompt)return{prompt:t.summary.prompt}},re=(e,t)=>{var r;if(!((r=t.summary)!=null&&r.chat))return;let s={conversationId:t.summary.chat.conversationId,turnId:t.summary.chat.turnId};return e.debug&&t.summary.chat.rephrasedQuery&&(s.rephrasedQuery=t.summary.chat.rephrasedQuery),s},se=e=>{if(!(!e.summary||!e.summary.factualConsistency))return{score:e.summary.factualConsistency.score}},ne=(e,t)=>{if(e.summary)return`${t}${e.summary.text}`};var Q=class{constructor(t,s=!1,r=200){this.eventInProgress="";this.updatedText="";this.events=[],this.onStreamEvent=t,this.includeRaw=s,this.status=r}consumeChunk(t){t.split(`
`).forEach(r=>{if(r.trim().length!==0&&r.indexOf("event:")!==0){r.indexOf("data:")===0?this.eventInProgress=r.slice(5,r.length):this.eventInProgress+=r;try{let n=JSON.parse(this.eventInProgress);this.enqueueEvent(n),this.eventInProgress=""}catch(n){n.stack.includes("at JSON.parse")||console.error(n)}}}),this.drainEvents()}enqueueEvent(t){let{type:s,messages:r,search_results:n,chat_id:u,turn_id:m,factual_consistency_score:f,generation_chunk:y,rendered_prompt:l,rephrased_query:h}=t;switch(s){case"error":this.events.push({type:"error",messages:r,...this.includeRaw&&{raw:t}});break;case"search_results":this.events.push({type:"searchResults",searchResults:n,...this.includeRaw&&{raw:t}});break;case"chat_info":this.events.push({type:"chatInfo",chatId:u,turnId:m,...this.includeRaw&&{raw:t}});break;case"generation_chunk":this.updatedText+=y,this.events.push({type:"generationChunk",updatedText:this.updatedText,generationChunk:y,...this.includeRaw&&{raw:t}});break;case"generation_info":this.events.push({type:"generationInfo",renderedPrompt:l,rephrasedQuery:h,...this.includeRaw&&{raw:t}});break;case"generation_end":this.events.push({type:"generationEnd",...this.includeRaw&&{raw:t}});break;case"factual_consistency_score":this.events.push({type:"factualConsistencyScore",factualConsistencyScore:f,...this.includeRaw&&{raw:t}});break;case"end":this.events.push({type:"end",...this.includeRaw&&{raw:t}});break;default:s?this.events.push({type:"unexpectedEvent",rawType:s,raw:t}):this.status!==200?this.events.push({type:"requestError",status:this.status,raw:t}):this.events.push({type:"unexpectedError",raw:t})}}drainEvents(){this.events.forEach(t=>{this.onStreamEvent(t)}),this.events=[]}};var ae=e=>{if(e){if(e.type==="none")return{type:e.type};if(e.type==="customer_reranker")return{type:e.type,reranker_id:e.rerankerId};if(e.type==="mmr")return{type:e.type,diversity_bias:e.diversityBias}}},oe=e=>{if(e){if(e.style==="none"||e.style==="numeric")return{style:e.style};if(e.style==="html"||e.style==="markdown")return{style:e.style,url_pattern:e.urlPattern,text_pattern:e.textPattern}}},z=async({streamQueryConfig:e,onStreamEvent:t,includeRawEvents:s=!1})=>{let{customerId:r,apiKey:n,authToken:u,domain:m,corpusKey:f,query:y,search:{metadataFilter:l,lexicalInterpolation:h,customDimensions:v,semantics:x,offset:E,limit:b,contextConfiguration:a,reranker:I},generation:C,chat:p}=e,g={query:y,search:{corpora:f.split(",").map(c=>({corpus_key:c,metadata_filter:l,lexical_interpolation:h,custom_dimensions:v,semantics:x})),offset:E,limit:b,context_configuration:{characters_before:a==null?void 0:a.charactersBefore,characters_after:a==null?void 0:a.charactersAfter,sentences_before:a==null?void 0:a.sentencesBefore,sentences_after:a==null?void 0:a.sentencesAfter,start_tag:a==null?void 0:a.startTag,end_tag:a==null?void 0:a.endTag},reranker:ae(I)},stream_response:!0};if(C){let{promptName:c,maxUsedSearchResults:_,promptText:S,maxResponseCharacters:R,responseLanguage:P,modelParameters:i,citations:q,enableFactualConsistencyScore:B}=C;g.generation={prompt_name:c,max_used_search_results:_,prompt_text:S,max_response_characters:R,response_language:P,model_parameters:i&&{max_tokens:i.maxTokens,temperature:i.temperature,frequency_penalty:i.frequencyPenalty,presence_penalty:i.presencePenalty},citations:oe(q),enable_factual_consistency_score:B}}p&&(g.chat={store:p.store});let o;p?p.conversationId?o=`/v2/chats/${p.conversationId}/turns`:o="/v2/chats":o="/v2/query";let d={"customer-id":r,"Content-Type":"application/json"};n&&(d["x-api-key"]=n),u&&(d.Authorization=`Bearer ${u}`);let T=`${m!=null?m:D}${o}`,k={method:"POST",url:T,headers:d,body:g};try{let{cancelStream:c,stream:_,status:S,responseHeaders:R}=await N(d,JSON.stringify(g),T);return(async()=>{try{let i=new Q(t,s,S);for await(let q of _)try{i.consumeChunk(q)}catch(B){G(B,t)}}catch(i){i instanceof DOMException&&i.name=="AbortError"||G(i,t)}})(),{cancelStream:c,request:k,status:S,responseHeaders:R}}catch(c){G(c,t)}return{request:k}},G=(e,t)=>{if(e instanceof Error)t({type:"genericError",error:e});else throw e};
