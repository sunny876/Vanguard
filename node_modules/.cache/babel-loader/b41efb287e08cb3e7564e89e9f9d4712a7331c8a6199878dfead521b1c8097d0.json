{"ast":null,"code":"import{BiDetail}from\"react-icons/bi\";import{VuiDrawer,VuiFlexContainer,VuiFlexItem,VuiHorizontalRule,VuiIcon,VuiSearchResult,VuiSpacer,VuiText,VuiTextColor,VuiTitle,truncateEnd,truncateStart}from\"../../ui\";import{useSearchContext}from\"../../contexts/SearchContext\";import\"./searchResultsDrawer.scss\";import{parseSnippet}from\"../../utils/parseSnippet\";import{getFcsScore}from\"../results/ResultHallucinationScore\";import{useState,useEffect}from\"react\";// Constants for FCS score thresholds\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const HIGH_RISK_THRESHOLD=0.33;// Vectara provides a requested number of sentences/characters before/after relevant reference snippets.\n// This variable allows for controlling the length of the text actually rendered to the screen.\nconst CONTEXT_MAX_LENGTH=200;export const SearchResultsDrawer=_ref=>{let{isOpen,onClose}=_ref;const{searchValue,searchResults}=useSearchContext();// State to hold sorted results\nconst[sortedResults,setSortedResults]=useState(searchResults);// Sort results when they change\nuseEffect(()=>{if(!searchResults){setSortedResults(undefined);return;}// Log original scores for debugging\nif(process.env.NODE_ENV!=='production'){console.log('Drawer - Original results:',searchResults.map(r=>({title:r.document_metadata.title,fcs:getFcsScore(r),score:r.score})));}// Create a copy of results to avoid modifying the original array\nconst filteredAndSortedResults=[...searchResults]// Filter out high risk results (FCS score <= 0.33)\n.filter(result=>{const fcsScore=getFcsScore(result);// Keep results with no FCS score or with scores above the high risk threshold\nreturn fcsScore<0||fcsScore>HIGH_RISK_THRESHOLD;})// Sort the filtered results by FCS score\n.sort((a,b)=>{// Get FCS scores for both results\nconst scoreA=getFcsScore(a);const scoreB=getFcsScore(b);// Force prioritize results with FCS scores\nif(scoreA>=0&&scoreB<0)return-1;if(scoreA<0&&scoreB>=0)return 1;// Sort by FCS score ascending (lowest first)\n// If both have valid scores, compare them\nif(scoreA>=0&&scoreB>=0){return scoreA-scoreB;// Ascending order (lowest first)\n}// If neither has a valid score, keep original order based on Vectara's score\nreturn b.score-a.score;});// Log sorted scores for debugging\nif(process.env.NODE_ENV!=='production'){console.log('Drawer - Sorted results:',filteredAndSortedResults.map(r=>({title:r.document_metadata.title,fcs:getFcsScore(r),score:r.score})));}setSortedResults(filteredAndSortedResults);},[searchResults]);return/*#__PURE__*/_jsxs(VuiDrawer,{isOpen:isOpen,onClose:onClose,title:/*#__PURE__*/_jsxs(VuiFlexContainer,{justifyContent:\"spaceBetween\",alignItems:\"center\",spacing:\"xs\",children:[/*#__PURE__*/_jsx(VuiFlexItem,{children:/*#__PURE__*/_jsx(VuiIcon,{size:\"s\",children:/*#__PURE__*/_jsx(BiDetail,{})})}),/*#__PURE__*/_jsx(VuiFlexItem,{grow:1,children:/*#__PURE__*/_jsx(VuiTitle,{size:\"s\",children:/*#__PURE__*/_jsx(\"h2\",{children:\"Review search results\"})})})]}),children:[/*#__PURE__*/_jsx(VuiText,{size:\"l\",children:/*#__PURE__*/_jsx(\"p\",{children:searchValue})}),/*#__PURE__*/_jsx(VuiSpacer,{size:\"xs\"}),/*#__PURE__*/_jsx(VuiHorizontalRule,{}),/*#__PURE__*/_jsx(VuiSpacer,{size:\"m\"}),/*#__PURE__*/_jsx(VuiText,{children:/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsx(VuiTextColor,{color:\"subdued\",children:\"These are all of the search results retrieved for this query. Not all of them will be used to generate a summary. High-risk results are excluded.\"})})}),/*#__PURE__*/_jsx(VuiSpacer,{size:\"m\"}),/*#__PURE__*/_jsx(\"div\",{className:\"searchResultsDrawerResults\",children:sortedResults===null||sortedResults===void 0?void 0:sortedResults.map((result,index)=>{const{pre,text,post}=parseSnippet(result.text);return/*#__PURE__*/_jsx(VuiSearchResult,{result:{title:result.document_metadata.title,url:result.document_metadata.url,snippet:{pre:truncateStart(pre,CONTEXT_MAX_LENGTH),text,post:truncateEnd(post,CONTEXT_MAX_LENGTH)}},position:index+1,subTitle:/*#__PURE__*/_jsx(VuiText,{size:\"s\",children:/*#__PURE__*/_jsx(\"p\",{children:/*#__PURE__*/_jsxs(VuiTextColor,{color:\"subdued\",children:[\"Source: \",result.document_metadata.source]})})})},result.text);})}),/*#__PURE__*/_jsx(VuiSpacer,{size:\"xl\"})]});};","map":{"version":3,"names":["BiDetail","VuiDrawer","VuiFlexContainer","VuiFlexItem","VuiHorizontalRule","VuiIcon","VuiSearchResult","VuiSpacer","VuiText","VuiTextColor","VuiTitle","truncateEnd","truncateStart","useSearchContext","parseSnippet","getFcsScore","useState","useEffect","jsx","_jsx","jsxs","_jsxs","HIGH_RISK_THRESHOLD","CONTEXT_MAX_LENGTH","SearchResultsDrawer","_ref","isOpen","onClose","searchValue","searchResults","sortedResults","setSortedResults","undefined","process","env","NODE_ENV","console","log","map","r","title","document_metadata","fcs","score","filteredAndSortedResults","filter","result","fcsScore","sort","a","b","scoreA","scoreB","justifyContent","alignItems","spacing","children","size","grow","color","className","index","pre","text","post","url","snippet","position","subTitle","source"],"sources":["/Users/syedali/POC/Create UI Threadneedle/columbia-threadneedle-demo/src/view/progressReport/SearchResultsDrawer.tsx"],"sourcesContent":["import { BiDetail } from \"react-icons/bi\";\nimport {\n  VuiDrawer,\n  VuiFlexContainer,\n  VuiFlexItem,\n  VuiHorizontalRule,\n  VuiIcon,\n  VuiSearchResult,\n  VuiSpacer,\n  VuiText,\n  VuiTextColor,\n  VuiTitle,\n  truncateEnd,\n  truncateStart\n} from \"../../ui\";\nimport { useSearchContext } from \"../../contexts/SearchContext\";\nimport \"./searchResultsDrawer.scss\";\nimport { parseSnippet } from \"../../utils/parseSnippet\";\nimport { SearchResultWithSnippet } from \"../types\";\nimport { getFcsScore } from \"../results/ResultHallucinationScore\";\nimport { useState, useEffect } from \"react\";\n\n// Constants for FCS score thresholds\nconst HIGH_RISK_THRESHOLD = 0.33;\n\ntype Props = {\n  isOpen: boolean;\n  onClose: () => void;\n};\n\n// Vectara provides a requested number of sentences/characters before/after relevant reference snippets.\n// This variable allows for controlling the length of the text actually rendered to the screen.\nconst CONTEXT_MAX_LENGTH = 200;\n\nexport const SearchResultsDrawer = ({ isOpen, onClose }: Props) => {\n  const { searchValue, searchResults } = useSearchContext();\n  \n  // State to hold sorted results\n  const [sortedResults, setSortedResults] = useState<SearchResultWithSnippet[] | undefined>(searchResults);\n  \n  // Sort results when they change\n  useEffect(() => {\n    if (!searchResults) {\n      setSortedResults(undefined);\n      return;\n    }\n    \n    // Log original scores for debugging\n    if (process.env.NODE_ENV !== 'production') {\n      console.log('Drawer - Original results:', searchResults.map(r => ({\n        title: r.document_metadata.title,\n        fcs: getFcsScore(r),\n        score: r.score\n      })));\n    }\n    \n    // Create a copy of results to avoid modifying the original array\n    const filteredAndSortedResults = [...searchResults]\n      // Filter out high risk results (FCS score <= 0.33)\n      .filter(result => {\n        const fcsScore = getFcsScore(result);\n        // Keep results with no FCS score or with scores above the high risk threshold\n        return fcsScore < 0 || fcsScore > HIGH_RISK_THRESHOLD;\n      })\n      // Sort the filtered results by FCS score\n      .sort((a, b) => {\n        // Get FCS scores for both results\n        const scoreA = getFcsScore(a);\n        const scoreB = getFcsScore(b);\n        \n        // Force prioritize results with FCS scores\n        if (scoreA >= 0 && scoreB < 0) return -1;\n        if (scoreA < 0 && scoreB >= 0) return 1;\n        \n        // Sort by FCS score ascending (lowest first)\n        // If both have valid scores, compare them\n        if (scoreA >= 0 && scoreB >= 0) {\n          return scoreA - scoreB; // Ascending order (lowest first)\n        }\n        \n        // If neither has a valid score, keep original order based on Vectara's score\n        return b.score - a.score;\n      });\n    \n    // Log sorted scores for debugging\n    if (process.env.NODE_ENV !== 'production') {\n      console.log('Drawer - Sorted results:', filteredAndSortedResults.map(r => ({\n        title: r.document_metadata.title,\n        fcs: getFcsScore(r),\n        score: r.score\n      })));\n    }\n    \n    setSortedResults(filteredAndSortedResults);\n  }, [searchResults]);\n\n  return (\n    <VuiDrawer\n      isOpen={isOpen}\n      onClose={onClose}\n      title={\n        <VuiFlexContainer justifyContent=\"spaceBetween\" alignItems=\"center\" spacing=\"xs\">\n          <VuiFlexItem>\n            <VuiIcon size=\"s\">\n              <BiDetail />\n            </VuiIcon>\n          </VuiFlexItem>\n\n          <VuiFlexItem grow={1}>\n            <VuiTitle size=\"s\">\n              <h2>Review search results</h2>\n            </VuiTitle>\n          </VuiFlexItem>\n        </VuiFlexContainer>\n      }\n    >\n      <VuiText size=\"l\">\n        <p>{searchValue}</p>\n      </VuiText>\n\n      <VuiSpacer size=\"xs\" />\n\n      <VuiHorizontalRule />\n\n      <VuiSpacer size=\"m\" />\n\n      <VuiText>\n        <p>\n          <VuiTextColor color=\"subdued\">\n            These are all of the search results retrieved for this query. Not all of them will be used to generate a\n            summary. High-risk results are excluded.\n          </VuiTextColor>\n        </p>\n      </VuiText>\n\n      <VuiSpacer size=\"m\" />\n\n      <div className=\"searchResultsDrawerResults\">\n        {sortedResults?.map((result, index) => {\n          const { pre, text, post } = parseSnippet(result.text);\n\n          return (\n            <VuiSearchResult\n              key={result.text}\n              result={{\n                title: result.document_metadata.title as string,\n                url: result.document_metadata.url as string,\n                snippet: {\n                  pre: truncateStart(pre, CONTEXT_MAX_LENGTH),\n                  text,\n                  post: truncateEnd(post, CONTEXT_MAX_LENGTH)\n                }\n              }}\n              position={index + 1}\n              subTitle={\n                <VuiText size=\"s\">\n                  <p>\n                    <VuiTextColor color=\"subdued\">Source: {result.document_metadata.source as string}</VuiTextColor>\n                  </p>\n                </VuiText>\n              }\n            />\n          );\n        })}\n      </div>\n\n      <VuiSpacer size=\"xl\" />\n    </VuiDrawer>\n  );\n};\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}